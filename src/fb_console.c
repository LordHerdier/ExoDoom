#include "fb_console.h"

// Font table omitted for brevity (Keep your existing font8x8_basic array here!)
// PASTE YOUR font8x8_basic ARRAY HERE
static const uint8_t font8x8_basic[128][8] = {
    // ... (Use the same font array from your original code) ...
    // 0-31: control chars (blank)
    [0 ... 31] = {0,0,0,0,0,0,0,0},

    // 32 ' '
    [32] = {0,0,0,0,0,0,0,0},
    [33] = {0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x00}, // !
    [34] = {0x36,0x36,0x24,0x00,0x00,0x00,0x00,0x00}, // "
    [35] = {0x36,0x36,0x7F,0x36,0x7F,0x36,0x36,0x00}, // #
    [36] = {0x0C,0x3E,0x03,0x1E,0x30,0x1F,0x0C,0x00}, // $
    [37] = {0x00,0x63,0x33,0x18,0x0C,0x66,0x63,0x00}, // %
    [38] = {0x1C,0x36,0x1C,0x6E,0x3B,0x33,0x6E,0x00}, // &
    [39] = {0x06,0x06,0x04,0x00,0x00,0x00,0x00,0x00}, // '
    [40] = {0x18,0x0C,0x06,0x06,0x06,0x0C,0x18,0x00}, // (
    [41] = {0x06,0x0C,0x18,0x18,0x18,0x0C,0x06,0x00}, // )
    [42] = {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00}, // *
    [43] = {0x00,0x0C,0x0C,0x3F,0x0C,0x0C,0x00,0x00}, // +
    [44] = {0x00,0x00,0x00,0x00,0x0C,0x0C,0x06,0x00}, // ,
    [45] = {0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00}, // -
    [46] = {0x00,0x00,0x00,0x00,0x0C,0x0C,0x00,0x00}, // .
    [47] = {0x60,0x30,0x18,0x0C,0x06,0x03,0x01,0x00}, // /

    // digits 0-9
    [48] = {0x3E,0x63,0x73,0x7B,0x6F,0x67,0x3E,0x00},
    [49] = {0x0C,0x0E,0x0C,0x0C,0x0C,0x0C,0x3F,0x00},
    [50] = {0x1E,0x33,0x30,0x1C,0x06,0x33,0x3F,0x00},
    [51] = {0x1E,0x33,0x30,0x1C,0x30,0x33,0x1E,0x00},
    [52] = {0x38,0x3C,0x36,0x33,0x7F,0x30,0x78,0x00},
    [53] = {0x3F,0x03,0x1F,0x30,0x30,0x33,0x1E,0x00},
    [54] = {0x1C,0x06,0x03,0x1F,0x33,0x33,0x1E,0x00},
    [55] = {0x3F,0x33,0x30,0x18,0x0C,0x0C,0x0C,0x00},
    [56] = {0x1E,0x33,0x33,0x1E,0x33,0x33,0x1E,0x00},
    [57] = {0x1E,0x33,0x33,0x3E,0x30,0x18,0x0E,0x00},

    // A-Z (65-90)
    [65] = {0x0C,0x1E,0x33,0x33,0x3F,0x33,0x33,0x00},
    [66] = {0x3F,0x66,0x66,0x3E,0x66,0x66,0x3F,0x00},
    [67] = {0x3C,0x66,0x03,0x03,0x03,0x66,0x3C,0x00},
    [68] = {0x1F,0x36,0x66,0x66,0x66,0x36,0x1F,0x00},
    [69] = {0x7F,0x46,0x16,0x1E,0x16,0x46,0x7F,0x00},
    [70] = {0x7F,0x46,0x16,0x1E,0x16,0x06,0x0F,0x00},
    [71] = {0x3C,0x66,0x03,0x03,0x73,0x66,0x7C,0x00},
    [72] = {0x33,0x33,0x33,0x3F,0x33,0x33,0x33,0x00},
    [73] = {0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E,0x00},
    [74] = {0x78,0x30,0x30,0x30,0x33,0x33,0x1E,0x00},
    [75] = {0x67,0x66,0x36,0x1E,0x36,0x66,0x67,0x00},
    [76] = {0x0F,0x06,0x06,0x06,0x46,0x66,0x7F,0x00},
    [77] = {0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0x00},
    [78] = {0x63,0x67,0x6F,0x7B,0x73,0x63,0x63,0x00},
    [79] = {0x1C,0x36,0x63,0x63,0x63,0x36,0x1C,0x00},
    [80] = {0x3F,0x66,0x66,0x3E,0x06,0x06,0x0F,0x00},
    [81] = {0x1E,0x33,0x33,0x33,0x3B,0x1E,0x38,0x00},
    [82] = {0x3F,0x66,0x66,0x3E,0x36,0x66,0x67,0x00},
    [83] = {0x1E,0x33,0x07,0x0E,0x38,0x33,0x1E,0x00},
    [84] = {0x3F,0x2D,0x0C,0x0C,0x0C,0x0C,0x1E,0x00},
    [85] = {0x33,0x33,0x33,0x33,0x33,0x33,0x3F,0x00},
    [86] = {0x33,0x33,0x33,0x33,0x33,0x1E,0x0C,0x00},
    [87] = {0x63,0x63,0x63,0x6B,0x7F,0x77,0x63,0x00},
    [88] = {0x63,0x63,0x36,0x1C,0x1C,0x36,0x63,0x00},
    [89] = {0x33,0x33,0x33,0x1E,0x0C,0x0C,0x1E,0x00},
    [90] = {0x7F,0x63,0x31,0x18,0x4C,0x66,0x7F,0x00},

    // a-z (97-122) basic-ish
    [97]  = {0x00,0x00,0x1E,0x30,0x3E,0x33,0x6E,0x00},
    [98]  = {0x07,0x06,0x06,0x3E,0x66,0x66,0x3B,0x00},
    [99]  = {0x00,0x00,0x1E,0x33,0x03,0x33,0x1E,0x00},
    [100] = {0x38,0x30,0x30,0x3E,0x33,0x33,0x6E,0x00},
    [101] = {0x00,0x00,0x1E,0x33,0x3F,0x03,0x1E,0x00},
    [102] = {0x1C,0x36,0x06,0x0F,0x06,0x06,0x0F,0x00},
    [103] = {0x00,0x00,0x6E,0x33,0x33,0x3E,0x30,0x1F},
    [104] = {0x07,0x06,0x36,0x6E,0x66,0x66,0x67,0x00},
    [105] = {0x0C,0x00,0x0E,0x0C,0x0C,0x0C,0x1E,0x00},
    [106] = {0x30,0x00,0x30,0x30,0x30,0x33,0x33,0x1E},
    [107] = {0x07,0x06,0x66,0x36,0x1E,0x36,0x67,0x00},
    [108] = {0x0E,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E,0x00},
    [109] = {0x00,0x00,0x33,0x7F,0x6B,0x63,0x63,0x00},
    [110] = {0x00,0x00,0x1B,0x37,0x33,0x33,0x33,0x00},
    [111] = {0x00,0x00,0x1E,0x33,0x33,0x33,0x1E,0x00},
    [112] = {0x00,0x00,0x3B,0x66,0x66,0x3E,0x06,0x0F},
    [113] = {0x00,0x00,0x6E,0x33,0x33,0x3E,0x30,0x78},
    [114] = {0x00,0x00,0x3B,0x6E,0x66,0x06,0x0F,0x00},
    [115] = {0x00,0x00,0x3E,0x03,0x1E,0x30,0x1F,0x00},
    [116] = {0x08,0x0C,0x3E,0x0C,0x0C,0x2C,0x18,0x00},
    [117] = {0x00,0x00,0x33,0x33,0x33,0x33,0x6E,0x00},
    [118] = {0x00,0x00,0x33,0x33,0x33,0x1E,0x0C,0x00},
    [119] = {0x00,0x00,0x63,0x63,0x6B,0x7F,0x36,0x00},
    [120] = {0x00,0x00,0x63,0x36,0x1C,0x36,0x63,0x00},
    [121] = {0x00,0x00,0x33,0x33,0x33,0x3E,0x30,0x1F},
    [122] = {0x00,0x00,0x3F,0x19,0x0C,0x26,0x3F,0x00},

    // everything else: blank
    [123 ... 127] = {0,0,0,0,0,0,0,0},
};

static inline void draw_glyph8x16(fb_console_t* con, uint32_t cx, uint32_t cy, uint8_t ch) {
    framebuffer_t* fb = con->fb;

    uint32_t px0 = cx * 8;
    uint32_t py0 = cy * 16;

    // clear cell background
    fb_fill_rect(fb, px0, py0, 8, 16, con->bg_r, con->bg_g, con->bg_b);

    const uint8_t* g = font8x8_basic[ch];

    // 8x8 font doubled vertically to 8x16
    for (uint32_t row = 0; row < 8; row++) {
        uint8_t bits = g[row];

        for (uint32_t col = 0; col < 8; col++) {
            bool on = (bits & (1u << col)) != 0;
            if (!on) continue;

            // draw 2 vertical pixels for each font row
            fb_fill_rect(fb, px0 + col, py0 + row*2, 1, 2, con->fg_r, con->fg_g, con->fg_b);
        }
    }
}

static void scroll_up_one_row(fb_console_t* con) {
    framebuffer_t* fb = con->fb;
    const uint32_t bytes_per_row = fb->pitch;
    const uint32_t scroll_px = 16; // one character row in pixels

    // Move framebuffer up by 16 px
    uint8_t* dst = fb->addr;
    uint8_t* src = fb->addr + scroll_px * bytes_per_row;
    uint32_t len = (fb->height - scroll_px) * bytes_per_row;

    if (src > dst) {
        for (uint32_t i = 0; i < len; i++) dst[i] = src[i];
    } else {
        for (uint32_t i = len; i > 0; i--) dst[i-1] = src[i-1];
    }

    // Clear bottom 16px
    fb_fill_rect(fb, 0, fb->height - scroll_px, fb->width, scroll_px, con->bg_r, con->bg_g, con->bg_b);
}

bool fbcon_init(fb_console_t* con, framebuffer_t* fb) {
    if (!con || !fb) return false;

    con->fb = fb;
    con->cols = fb->width / 8;
    con->rows = fb->height / 16;
    if (con->cols == 0 || con->rows == 0) return false;

    con->cursor_x = 0;
    con->cursor_y = 0;

    con->fg_r = 255; con->fg_g = 255; con->fg_b = 255;
    con->bg_r = 0;   con->bg_g = 0;   con->bg_b = 0;

    con->show_cursor = true;

    fbcon_clear(con);
    return true;
}

void fbcon_set_color(fb_console_t* con,
                     uint8_t fg_r, uint8_t fg_g, uint8_t fg_b,
                     uint8_t bg_r, uint8_t bg_g, uint8_t bg_b) {
    if (!con) return;
    con->fg_r = fg_r; con->fg_g = fg_g; con->fg_b = fg_b;
    con->bg_r = bg_r; con->bg_g = bg_g; con->bg_b = bg_b;
}

void fbcon_clear(fb_console_t* con) {
    if (!con) return;
    fb_clear(con->fb, con->bg_r, con->bg_g, con->bg_b);
    con->cursor_x = 0;
    con->cursor_y = 0;
}

void fbcon_enable_cursor(fb_console_t* con, bool enable) {
    if (!con) return;
    con->show_cursor = enable;
}

void fbcon_redraw_cursor(fb_console_t* con) {
    if (!con || !con->show_cursor) return;
    uint32_t x = con->cursor_x * 8;
    uint32_t y = con->cursor_y * 16 + 15;
    fb_fill_rect(con->fb, x, y, 8, 1, con->fg_r, con->fg_g, con->fg_b);
}

static void newline(fb_console_t* con) {
    con->cursor_x = 0;
    con->cursor_y++;

    if (con->cursor_y >= con->rows) {
        scroll_up_one_row(con);
        con->cursor_y = con->rows - 1;
    }
}

void fbcon_putc(fb_console_t* con, char c) {
    if (!con) return;

    // Erase cursor at current position
    if (con->show_cursor) {
        uint32_t x = con->cursor_x * 8;
        uint32_t y = con->cursor_y * 16 + 15;
        fb_fill_rect(con->fb, x, y, 8, 1, con->bg_r, con->bg_g, con->bg_b);
    }

    // Handle Backspace
    if (c == '\b') {
        if (con->cursor_x > 0) {
            con->cursor_x--;
        } else if (con->cursor_y > 0) {
            con->cursor_y--;
            con->cursor_x = con->cols - 1;
        }
        // Overwrite the character at the new cursor position with a space
        draw_glyph8x16(con, con->cursor_x, con->cursor_y, ' ');
        fbcon_redraw_cursor(con);
        return;
    }

    if (c == '\n') { newline(con); fbcon_redraw_cursor(con); return; }
    if (c == '\r') { con->cursor_x = 0; fbcon_redraw_cursor(con); return; }
    if (c == '\t') {
        uint32_t next = (con->cursor_x + 4) & ~3u;
        while (con->cursor_x < next) fbcon_putc(con, ' ');
        return;
    }

    uint8_t ch = (uint8_t)c;
    if (ch >= 128) ch = '?';

    draw_glyph8x16(con, con->cursor_x, con->cursor_y, ch);

    con->cursor_x++;
    if (con->cursor_x >= con->cols) newline(con);

    fbcon_redraw_cursor(con);
}

void fbcon_write(fb_console_t* con, const char* s) {
    if (!con || !s) return;
    while (*s) fbcon_putc(con, *s++);
}